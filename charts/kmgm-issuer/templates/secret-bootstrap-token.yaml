{{- if .Values.kmgm.bootstrap.secret.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "kmgm.tokenSecretName" . }}
  labels:
    {{- include "kmgm.labels" . | nindent 4 }}
type: Opaque
data:
{{- /*
https://github.com/helm/helm/issues/3053#issuecomment-782837107
*/ -}}
{{- $previous := lookup "v1" "Secret" .Release.Namespace (include "kmgm.tokenSecretName" .) }}
{{- if $previous }}
  token: {{ $previous.data.token }}
{{- else if .Values.kmgm.bootstrap.token }}
  token: {{ .Values.kmgm.bootstrap.token | b64enc | quote }}
{{- else }}
  token: {{ randAlphaNum 32 | b64enc | quote }}
{{- end }}
{{- end }}
